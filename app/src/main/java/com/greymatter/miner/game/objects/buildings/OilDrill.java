package com.greymatter.miner.game.objects.buildings;import com.greymatter.miner.animators.BooleanAnimator;import com.greymatter.miner.animators.OnAnimationFrameHandler;import com.greymatter.miner.animators.ValueAnimator;import com.greymatter.miner.containers.GameObjectsContainer;import com.greymatter.miner.containers.MaterialContainer;import com.greymatter.miner.game.GameInstance;import com.greymatter.miner.game.manager.GameManager;import com.greymatter.miner.game.objects.GameInstanceGroup;import com.greymatter.miner.game.objects.GameObject;import com.greymatter.miner.game.objects.base.IGameObject;import com.greymatter.miner.helpers.VectorHelper;import com.greymatter.miner.helpers.ZHelper;import com.greymatter.miner.loaders.enums.definitions.DrawableDef;import com.greymatter.miner.loaders.enums.definitions.MaterialDef;import com.greymatter.miner.mainui.touch.OnTouchListener;import com.greymatter.miner.opengl.objects.Transforms;import com.greymatter.miner.opengl.objects.drawables.Drawable;import com.greymatter.miner.opengl.objects.drawables.InstanceGroup;import com.greymatter.miner.opengl.objects.renderers.InstancedRenderer;import javax.vecmath.Vector2f;import javax.vecmath.Vector3f;public class OilDrill extends GameBuilding {    private static final String PIPES_INS_GROUP = "pipes_ig";    private static final String JOINTS_INS_GROUP = "joints_ig";    private GameInstanceGroup pipelineGroup, jointIndicators;    public OilDrill(Drawable drawable) {        super(drawable.getId(), drawable);        initialize();    }    public OilDrill(String id, Drawable drawable) {        super(id, drawable);        initialize();    }    public OilDrill(String id) {        super(id, DrawableDef.create(DrawableDef.OIL_DRILL));        initialize();    }    private void initialize() {        pipelineGroup = new GameInstanceGroup(DrawableDef.create(DrawableDef.PIPES_INSTANCE_GROUP));        pipelineGroup.moveTo(0f,0f, ZHelper.FRONT);        this.addChild(PIPES_INS_GROUP, pipelineGroup);        jointIndicators = new GameInstanceGroup(DrawableDef.create(DrawableDef.JOINTS_INSTANCE_GROUP));        jointIndicators.moveTo(0f,0f, ZHelper.OVER_FRONT);        this.addChild(JOINTS_INS_GROUP, jointIndicators);        GameObject firstJointInstance = jointIndicators.createAndAddInstance();        firstJointInstance.setCircularRB();        firstJointInstance.setOnTouchListener(jointTouchListener);        firstJointInstance.moveTo(0f,0f, 20f);        firstJointInstance.scaleTo(0.3f,0.3f);        jointIndicators.setAnimator(new BooleanAnimator().withFPS(10).setOnAnimationFrameHandler(new OnAnimationFrameHandler() {            @Override            public void onAnimationFrame(GameObject object, ValueAnimator animator) {                for (int i = 0; i < jointIndicators.getTotalInstances(); i++) {                    jointIndicators.getInstance(i).getTransforms().rotateBy(0f,0f,10f);                }            }        }));    }    @Override    public void onFrameUpdate() {        super.onFrameUpdate();        jointIndicators.getAnimator().update();    }    @Override    public void onTransformsChanged() {        super.onTransformsChanged();        if(jointIndicators!=null) {            Vector3f scale = getTransforms().getScale();            float drillRotation = getTransforms().getRotation().z;            Vector2f ptToRotate = new Vector2f(-(scale.x-scale.x*0.33f) , -scale.y);            ptToRotate = VectorHelper.rotateAroundZ(ptToRotate, (float)Math.toRadians(drillRotation));            jointIndicators.getInstance(0).moveTo(getLocation().x + ptToRotate.x,                    getLocation().y + ptToRotate.y);        }    }    public GameInstance addInstance() {        GameInstance newInstance = pipelineGroup.createAndAddInstance();        newInstance.getTransforms().setTranslationTransformationOffset(new Vector3f(1f,0f,0f));        newInstance.getTransforms().scaleTo(0f,0.3f);        return newInstance;    }    OnTouchListener jointTouchListener = new OnTouchListener() {        @Override        public boolean onTouchDown(IGameObject gameObject, Vector2f pointer) {            GameObject newPipeInstance = addInstance();            newPipeInstance.moveTo(gameObject.getLocation().x,gameObject.getLocation().y, ZHelper.FRONT);            return true;        }        @Override        public boolean onTouchMove(IGameObject gameObject, Vector2f pointer) {            Transforms transforms = pipelineGroup.getChild("INSTANCE_"  + (pipelineGroup.getTotalInstances()-1)).getTransforms();            Vector3f pointer3f = VectorHelper.toVector3f(pointer);            float scaleDist = (float)VectorHelper.getDistanceWithSQRT(transforms.getTranslation(), pointer3f);            float angle = (float)VectorHelper.angleBetweenDegrees(transforms.getTranslation(), pointer3f);            transforms.scaleTo(scaleDist/2, transforms.getScale().y);            transforms.rotateTo(0f,0f,angle);            return true;        }        @Override        public boolean onTouchUp(IGameObject gameObject, Vector2f pointer) {            GameObject newInstance = jointIndicators.createAndAddInstance();            newInstance.setCircularRB();            newInstance.moveTo(pointer.x, pointer.y, ZHelper.OVER_FRONT);            newInstance.scaleTo(0.3f,0.3f);            newInstance.setOnTouchListener(jointTouchListener);            return false;        }    };}